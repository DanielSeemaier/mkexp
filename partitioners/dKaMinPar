#!/bin/bash
. "$script_pwd/../partitioners/_KaGenPartitioner"

DKAMINPAR_USE_KAGEN_DRIVER=0

FetchDiskDriver() {
    local -n args=$1

    src_dir="$PREFIX/src/${args[algorithm_version]}/KaMinPar"
    if [[ ! -d "$src_dir" ]]; then
        mkdir -p "$src_dir"
        git clone git@github.com:DanielSeemaier/KaMinPar.git "$src_dir"
        git -C "$src_dir" submodule update --init --recursive
    else
        git -C "$src_dir" fetch origin
        git -C "$src_dir" submodule update
    fi

    branch="main"
    if [[ "${args[algorithm_version]}" != "latest" ]]; then 
        branch="${args[algorithm_version]}"
    fi
    git -C "$src_dir" reset --hard "$branch"
}

InstallDiskDriver() {
    local -n args=$1

    src_dir="$PREFIX/src/${args[algorithm_version]}/KaMinPar"
    cmake -S "$src_dir" -B "$src_dir/build" -DCMAKE_BUILD_TYPE=Release -DKAMINPAR_BUILD_DISTRIBUTED=On $CUSTOM_CMAKE_FLAGS ${args[build_options]}
    cmake --build "$src_dir/build" --target dKaMinPar --parallel
    cp "$src_dir/build/apps/dKaMinPar" "${args[binary_disk]}"
}

FetchKaGenDriver() {
    if [[ $DKAMINPAR_USE_KAGEN_DRIVER == 1 ]]; then 
        src_dir="$PREFIX/src/KaGen-Partitioner"
        if [[ ! -d "$src_dir" ]]; then
            mkdir -p "$src_dir"
            git clone git@github.com:KaHIP/KaGen-Partitioner.git "$src_dir"
        else 
            git -C "$src_dir" pull
        fi
    else
        FetchDiskDriver $1
    fi
}

InstallKaGenDriver() {
    local -n args=$1

    if [[ $DKAMINPAR_USE_KAGEN_DRIVER == 1 ]]; then 
        src_dir="$PREFIX/src/KaGen-Partitioner"
        cmake -S "$src_dir" -B "$src_dir/build" -DCMAKE_BUILD_TYPE=Release -DBUILD_DKAMINPAR=On $CUSTOM_CMAKE_FLAGS ${args[build_options]}
        cmake --build "$src_dir/build" --parallel
        cp "$src_dir/build/dKaMinPar" "${args[binary_kagen]}"
    else
        src_dir="$PREFIX/src/${args[algorithm_version]}/KaMinPar"
        cmake -S "$src_dir" -B "$src_dir/build" -DCMAKE_BUILD_TYPE=Release -DKAMINPAR_BUILD_DISTRIBUTED=On $CUSTOM_CMAKE_FLAGS ${args[build_options]}
        cmake --build "$src_dir/build" --target dKaMinPar --parallel
        cp "$src_dir/build/apps/dKaMinPar" "${args[binary_kagen]}"
    fi
}

Fetch() {
    local -n fetch_args=$1

    if (( ${fetch_args[install_disk]} )); then 
        FetchDiskDriver fetch_args
    fi
    if (( ${fetch_args[install_kagen]} )); then 
        FetchKaGenDriver fetch_args
    fi
}

Install() {
    local -n install_args=$1
    
    if (( ${install_args[install_disk]} )); then 
        InstallDiskDriver install_args
    fi
    if (( ${install_args[install_kagen]} )); then 
        InstallKaGenDriver install_args
    fi
}

InvokeFromDisk() {
    local -n args=$1
    
    graph="${args[graph]}"
    [[ -f "$graph.graph" ]] && graph="$graph.graph"
    [[ -f "$graph.metis" ]] && graph="$graph.metis"
    [[ -f "$graph.bgf" ]] && graph="$graph.bgf"

    part_output=""
    #part_output="-o $misc_files_dir/${args[algorithm]}/${args[id]}.part"
    
    if [[ -f "$graph" ]]; then
        echo "${args[binary]} -G $graph -k ${args[k]} -e ${args[epsilon]} --seed=${args[seed]} -t ${args[num_threads]} -T ${args[algorithm_arguments]} $part_output"
    else 
        >&2 echo "Warning: Graph $graph does not exist"
        return 1
    fi
}

InvokeFromKaGen() {
    local -n args=$1
    echo -n "${args[binary]} "
    echo -n "--seed ${args[seed]} " 
    echo -n "-k ${args[k]} "
    echo -n "-t ${args[num_threads]} "
    echo -n "-e ${args[epsilon]} -T ${args[algorithm_arguments]} "
    echo -n "-G\"${args[kagen_arguments_stringified]}\""
    echo ""
}
